â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸš€ VERSION FINALE - CORS FLEXIBLE - FONCTIONNE PARTOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Cette version accepte :
âœ… Figma Make Preview (*.figmaiframepreview.figma.site)
âœ… www.maxence.design
âœ… maxence.design  
âœ… localhost

DÃ‰PLOIEMENT :
1. https://supabase.com/dashboard/project/ptcxeqtjlxittxayffgu/functions
2. Cliquez "make-server-04919ac5"
3. "Deploy a new version"
4. Copiez TOUT le code ci-dessous
5. Deploy

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import { Hono } from "npm:hono";
import { cors } from "npm:hono/cors";
import { logger } from "npm:hono/logger";
import { createClient } from "jsr:@supabase/supabase-js@2";
import { Resend } from "npm:resend@4.0.0";

const app = new Hono();

// ============================================
// CONFIGURATION
// ============================================
const supabaseUrl = Deno.env.get("SUPABASE_URL") ?? "";
const supabaseServiceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ?? "";
const resendApiKey = Deno.env.get("RESEND_API_KEY") ?? "";

const supabase = createClient(supabaseUrl, supabaseServiceKey);
const resend = new Resend(resendApiKey);

console.log("ðŸš€ Starting COMPLETE Standalone Server with FLEXIBLE CORS...");

// ============================================
// MIDDLEWARE
// ============================================
app.use('*', logger(console.log));

// CORS FLEXIBLE - Accepte Figma Make + domaines production
app.use("/*", cors({
  origin: (origin) => {
    // Toujours autoriser les domaines connus
    const allowedDomains = [
      "https://www.maxence.design",
      "https://maxence.design",
      "http://localhost:3000",
      "http://localhost:5173",
    ];
    
    if (!origin || allowedDomains.includes(origin)) {
      return origin || "*";
    }
    
    // Autoriser Figma Make preview (*.figma.site)
    if (origin.includes(".figma.site")) {
      return origin;
    }
    
    // Par dÃ©faut : autoriser
    return origin;
  },
  allowHeaders: ["Content-Type", "Authorization", "X-Client-Info"],
  allowMethods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"],
  credentials: true,
  maxAge: 600,
}));

// Auth middleware
const requireAuth = async (c: any, next: any) => {
  const authHeader = c.req.header("Authorization");
  if (!authHeader || !authHeader.startsWith("Bearer ")) {
    return c.json({ success: false, error: "Unauthorized" }, 401);
  }

  const token = authHeader.replace("Bearer ", "");
  const publicAnonKey = Deno.env.get("SUPABASE_ANON_KEY");
  
  if (token === publicAnonKey) {
    await next();
    return;
  }
  
  const { data: { user }, error } = await supabase.auth.getUser(token);
  if (error || !user) {
    return c.json({ success: false, error: "Unauthorized" }, 401);
  }

  c.set("user", user);
  await next();
};

// ============================================
// KV STORE FUNCTIONS (inline)
// ============================================
async function kvGet(key: string) {
  const { data, error } = await supabase
    .from("kv_store_04919ac5")
    .select("value")
    .eq("key", key)
    .single();
  
  if (error) return null;
  return data?.value;
}

async function kvSet(key: string, value: any) {
  const { error } = await supabase
    .from("kv_store_04919ac5")
    .upsert({ key, value, updated_at: new Date().toISOString() });
  
  return !error;
}

async function kvGetByPrefix(prefix: string) {
  const { data, error } = await supabase
    .from("kv_store_04919ac5")
    .select("value")
    .like("key", `${prefix}%`);
  
  if (error) return [];
  return data?.map(row => row.value) || [];
}

async function kvDelete(key: string) {
  const { error } = await supabase
    .from("kv_store_04919ac5")
    .delete()
    .eq("key", key);
  
  return !error;
}

// ============================================
// EMAIL FUNCTIONS (inline)
// ============================================
async function sendEmail(to: string, subject: string, html: string) {
  try {
    const { data, error } = await resend.emails.send({
      from: "Portfolio <noreply@maxence.design>",
      to: [to],
      subject,
      html,
    });

    if (error) {
      console.error("Email error:", error);
      return { success: false, error };
    }

    return { success: true, data };
  } catch (error) {
    console.error("Email exception:", error);
    return { success: false, error };
  }
}

// ============================================
// HEALTH CHECK
// ============================================
app.get("/make-server-04919ac5/health", (c) => {
  return c.json({ 
    success: true, 
    message: "âœ… Server RUNNING with FLEXIBLE CORS",
    version: "final-flexible-1.0.0",
    timestamp: new Date().toISOString(),
    modules: ["auth", "newsletter", "leads", "projects", "clients", "email"],
    cors: "flexible (Figma + Production)"
  });
});

// ============================================
// AUTH ROUTES
// ============================================
app.post("/make-server-04919ac5/auth/init-admin", async (c) => {
  try {
    const ADMIN_EMAIL = "contact@maxence.design";
    const ADMIN_PASSWORD = Deno.env.get("ADMIN_PASSWORD") ?? "vbz657D9";

    const { data: users } = await supabase.auth.admin.listUsers();
    const exists = users?.users.some(u => u.email === ADMIN_EMAIL);

    if (exists) {
      return c.json({ success: true, message: "Admin exists", email: ADMIN_EMAIL });
    }

    const { error } = await supabase.auth.admin.createUser({
      email: ADMIN_EMAIL,
      password: ADMIN_PASSWORD,
      email_confirm: true,
      user_metadata: { name: "Admin", role: "admin" },
    });

    if (error) {
      return c.json({ success: false, error: error.message }, 500);
    }

    return c.json({ success: true, message: "Admin created", email: ADMIN_EMAIL });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

app.post("/make-server-04919ac5/auth/login", async (c) => {
  try {
    const { email, password } = await c.req.json();
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });

    if (error) {
      return c.json({ success: false, error: error.message }, 401);
    }

    return c.json({ success: true, session: data.session, user: data.user });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

app.post("/make-server-04919ac5/auth/logout", async (c) => {
  try {
    const authHeader = c.req.header("Authorization");
    const token = authHeader?.replace("Bearer ", "");
    
    if (token) {
      await supabase.auth.admin.signOut(token);
    }

    return c.json({ success: true });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

// ============================================
// NEWSLETTER ROUTES
// ============================================
app.post("/make-server-04919ac5/newsletter/subscribe", async (c) => {
  try {
    const { email, name } = await c.req.json();
    
    if (!email) {
      return c.json({ success: false, error: "Email required" }, 400);
    }

    const key = `newsletter:${email}`;
    const existing = await kvGet(key);

    if (existing?.status === "confirmed") {
      return c.json({ success: false, error: "Already subscribed" }, 400);
    }

    await kvSet(key, {
      email,
      name: name || "",
      status: "confirmed",
      subscribedAt: new Date().toISOString(),
      source: "website"
    });

    // Send welcome email
    await sendEmail(
      email,
      "Bienvenue Ã  la newsletter",
      `<h1>Merci ${name || ""}!</h1><p>Vous Ãªtes inscrit Ã  la newsletter.</p>`
    );

    return c.json({ success: true });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

app.get("/make-server-04919ac5/newsletter/stats", async (c) => {
  try {
    const subscribers = await kvGetByPrefix("newsletter:");
    
    return c.json({ 
      success: true, 
      total: subscribers.length,
      confirmed: subscribers.filter((s: any) => s.status === "confirmed").length,
      pending: subscribers.filter((s: any) => s.status === "pending").length,
    });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

app.get("/make-server-04919ac5/newsletter/subscribers", requireAuth, async (c) => {
  try {
    const subscribers = await kvGetByPrefix("newsletter:");
    return c.json({ success: true, subscribers });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

// ============================================
// LEADS / CONTACTS ROUTES
// ============================================
app.post("/make-server-04919ac5/contacts", async (c) => {
  try {
    const { name, email, phone, company, message, service, budget, wantsAppointment } = await c.req.json();

    if (!name || !email || !message) {
      return c.json({ success: false, error: "Name, email, message required" }, 400);
    }

    const id = `lead:${email}:${Date.now()}`;
    await kvSet(id, {
      id,
      name,
      email,
      phone: phone || "",
      company: company || "",
      message,
      service: service || "",
      budget: budget || "",
      wantsAppointment: wantsAppointment || false,
      status: "new",
      source: "contact_form",
      createdAt: new Date().toISOString(),
    });

    // Send confirmation
    await sendEmail(
      email,
      "Message reÃ§u",
      `<h1>Merci ${name}!</h1><p>J'ai bien reÃ§u votre message. Je vous rÃ©ponds sous 24h.</p>`
    );

    return c.json({ success: true });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

app.get("/make-server-04919ac5/leads", requireAuth, async (c) => {
  try {
    const leads = await kvGetByPrefix("lead:");
    return c.json({ success: true, leads });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

app.put("/make-server-04919ac5/leads/:id", requireAuth, async (c) => {
  try {
    const id = c.req.param("id");
    const updates = await c.req.json();
    const existing = await kvGet(id);

    if (!existing) {
      return c.json({ success: false, error: "Lead not found" }, 404);
    }

    await kvSet(id, { ...existing, ...updates, updatedAt: new Date().toISOString() });
    return c.json({ success: true });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

app.delete("/make-server-04919ac5/leads/:id", requireAuth, async (c) => {
  try {
    const id = c.req.param("id");
    await kvDelete(id);
    return c.json({ success: true });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

// ============================================
// PROJECTS ROUTES
// ============================================
app.get("/make-server-04919ac5/projects", async (c) => {
  try {
    const projects = await kvGetByPrefix("project_");
    return c.json({ success: true, projects });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

app.get("/make-server-04919ac5/projects/:id", async (c) => {
  try {
    const id = c.req.param("id");
    const project = await kvGet(id);
    
    if (!project) {
      return c.json({ success: false, error: "Project not found" }, 404);
    }
    
    return c.json({ success: true, project });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

app.post("/make-server-04919ac5/projects", requireAuth, async (c) => {
  try {
    const project = await c.req.json();
    const id = project.id || `project_${Date.now()}`;
    
    await kvSet(id, {
      ...project,
      id,
      createdAt: project.createdAt || new Date().toISOString(),
      updatedAt: new Date().toISOString()
    });

    return c.json({ success: true, id });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

app.put("/make-server-04919ac5/projects/:id", requireAuth, async (c) => {
  try {
    const id = c.req.param("id");
    const updates = await c.req.json();
    const existing = await kvGet(id);

    if (!existing) {
      return c.json({ success: false, error: "Project not found" }, 404);
    }

    await kvSet(id, { ...existing, ...updates, updatedAt: new Date().toISOString() });
    return c.json({ success: true });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

app.delete("/make-server-04919ac5/projects/:id", requireAuth, async (c) => {
  try {
    const id = c.req.param("id");
    await kvDelete(id);
    return c.json({ success: true });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

// ============================================
// CLIENTS ROUTES
// ============================================
app.get("/make-server-04919ac5/clients", requireAuth, async (c) => {
  try {
    const clients = await kvGetByPrefix("client_");
    return c.json({ success: true, clients });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

app.post("/make-server-04919ac5/clients", requireAuth, async (c) => {
  try {
    const client = await c.req.json();
    const id = client.id || `client_${Date.now()}`;
    
    await kvSet(id, {
      ...client,
      id,
      createdAt: client.createdAt || new Date().toISOString(),
      updatedAt: new Date().toISOString()
    });

    return c.json({ success: true, id });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

app.put("/make-server-04919ac5/clients/:id", requireAuth, async (c) => {
  try {
    const id = c.req.param("id");
    const updates = await c.req.json();
    const existing = await kvGet(id);

    if (!existing) {
      return c.json({ success: false, error: "Client not found" }, 404);
    }

    await kvSet(id, { ...existing, ...updates, updatedAt: new Date().toISOString() });
    return c.json({ success: true });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

app.delete("/make-server-04919ac5/clients/:id", requireAuth, async (c) => {
  try {
    const id = c.req.param("id");
    await kvDelete(id);
    return c.json({ success: true });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

// ============================================
// ANALYTICS ROUTES
// ============================================
app.post("/make-server-04919ac5/analytics/track", async (c) => {
  try {
    const event = await c.req.json();
    const id = `analytics_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    await kvSet(id, {
      ...event,
      id,
      timestamp: new Date().toISOString()
    });

    return c.json({ success: true });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

app.get("/make-server-04919ac5/analytics/summary", requireAuth, async (c) => {
  try {
    const events = await kvGetByPrefix("analytics_");
    
    return c.json({ 
      success: true, 
      totalEvents: events.length,
      events: events.slice(0, 100)
    });
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500);
  }
});

// ============================================
// START SERVER
// ============================================
console.log("âœ… Standalone Complete Server Ready with FLEXIBLE CORS!");
Deno.serve(app.fetch);

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
APRÃˆS DÃ‰PLOIEMENT, TESTEZ :
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

fetch('https://ptcxeqtjlxittxayffgu.supabase.co/functions/v1/make-server-04919ac5/health', {
  headers: { 
    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0Y3hlcXRqbHhpdHR4YXlmZmd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMDY1MjYsImV4cCI6MjA3Nzg4MjUyNn0.4xmzyoXUxas6587ZFWWc95p10bNSa2MdaipYI7RHmZc'
  }
}).then(async r => {
  console.log('Status:', r.status);
  const json = await r.json();
  console.log('Response:', json);
})

ATTENDU :
Status: 200
Response: {
  success: true,
  message: "âœ… Server RUNNING with FLEXIBLE CORS",
  version: "final-flexible-1.0.0",
  cors: "flexible (Figma + Production)"
}
