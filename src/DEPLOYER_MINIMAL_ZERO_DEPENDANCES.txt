â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸš€ VERSION MINIMALE - ZÃ‰RO DÃ‰PENDANCES - 100% DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Cette version :
âœ… N'a AUCUNE dÃ©pendance NPM (pas de Resend, pas de Hono extras)
âœ… Fonctionne 100% dans le dashboard Supabase
âœ… CORS configurÃ© pour Figma + Production
âœ… Routes essentielles uniquement

DÃ‰PLOIEMENT :
1. https://supabase.com/dashboard/project/ptcxeqtjlxittxayffgu/functions
2. Cliquez "make-server-04919ac5"
3. "Deploy a new version"
4. SUPPRIMEZ TOUT
5. Copiez UNIQUEMENT le code entre les lignes â•â•â•
6. Deploy

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DÃ‰BUT DU CODE - COPIEZ Ã€ PARTIR D'ICI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import { Hono } from "npm:hono@4";
import { cors } from "npm:hono@4/cors";
import { logger } from "npm:hono@4/logger";
import { createClient } from "jsr:@supabase/supabase-js@2";

const app = new Hono();

// Config
const supabaseUrl = Deno.env.get("SUPABASE_URL") ?? "";
const supabaseKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ?? "";
const supabase = createClient(supabaseUrl, supabaseKey);

console.log("ðŸš€ Minimal Server Starting...");

// Logger
app.use('*', logger(console.log));

// CORS - Accepte TOUT pour tester
app.use("/*", cors({
  origin: "*",
  allowHeaders: ["Content-Type", "Authorization", "X-Client-Info"],
  allowMethods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"],
  credentials: false,
}));

// KV Functions
async function kvGet(key: string) {
  const { data } = await supabase
    .from("kv_store_04919ac5")
    .select("value")
    .eq("key", key)
    .single();
  return data?.value || null;
}

async function kvSet(key: string, value: any) {
  await supabase
    .from("kv_store_04919ac5")
    .upsert({ key, value, updated_at: new Date().toISOString() });
}

async function kvGetByPrefix(prefix: string) {
  const { data } = await supabase
    .from("kv_store_04919ac5")
    .select("value")
    .like("key", `${prefix}%`);
  return data?.map(row => row.value) || [];
}

async function kvDelete(key: string) {
  await supabase
    .from("kv_store_04919ac5")
    .delete()
    .eq("key", key);
}

// HEALTH CHECK
app.get("/make-server-04919ac5/health", (c) => {
  console.log("âœ… Health check called");
  return c.json({ 
    success: true, 
    message: "ðŸŽ‰ MINIMAL SERVER IS RUNNING!",
    version: "minimal-1.0.0",
    timestamp: new Date().toISOString(),
    cors: "open (testing)"
  });
});

// INIT ADMIN
app.post("/make-server-04919ac5/auth/init-admin", async (c) => {
  const ADMIN_EMAIL = "contact@maxence.design";
  const ADMIN_PASSWORD = Deno.env.get("ADMIN_PASSWORD") ?? "vbz657D9";

  const { data: users } = await supabase.auth.admin.listUsers();
  const exists = users?.users.some(u => u.email === ADMIN_EMAIL);

  if (exists) {
    return c.json({ success: true, message: "Admin exists" });
  }

  const { error } = await supabase.auth.admin.createUser({
    email: ADMIN_EMAIL,
    password: ADMIN_PASSWORD,
    email_confirm: true,
    user_metadata: { name: "Admin", role: "admin" },
  });

  return c.json({ success: !error, error: error?.message });
});

// LOGIN
app.post("/make-server-04919ac5/auth/login", async (c) => {
  const { email, password } = await c.req.json();
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  
  if (error) {
    return c.json({ success: false, error: error.message }, 401);
  }
  
  return c.json({ success: true, session: data.session, user: data.user });
});

// NEWSLETTER
app.get("/make-server-04919ac5/newsletter/stats", async (c) => {
  const subs = await kvGetByPrefix("newsletter:");
  return c.json({ 
    success: true, 
    total: subs.length,
    confirmed: subs.filter((s: any) => s.status === "confirmed").length 
  });
});

app.post("/make-server-04919ac5/newsletter/subscribe", async (c) => {
  const { email, name } = await c.req.json();
  await kvSet(`newsletter:${email}`, {
    email,
    name: name || "",
    status: "confirmed",
    subscribedAt: new Date().toISOString()
  });
  return c.json({ success: true });
});

// CONTACTS/LEADS
app.post("/make-server-04919ac5/contacts", async (c) => {
  const body = await c.req.json();
  const id = `lead:${body.email}:${Date.now()}`;
  await kvSet(id, { ...body, id, createdAt: new Date().toISOString() });
  return c.json({ success: true });
});

app.get("/make-server-04919ac5/leads", async (c) => {
  const leads = await kvGetByPrefix("lead:");
  return c.json({ success: true, leads });
});

// PROJECTS
app.get("/make-server-04919ac5/projects", async (c) => {
  const projects = await kvGetByPrefix("project_");
  return c.json({ success: true, projects });
});

app.post("/make-server-04919ac5/projects", async (c) => {
  const project = await c.req.json();
  const id = project.id || `project_${Date.now()}`;
  await kvSet(id, { ...project, id, updatedAt: new Date().toISOString() });
  return c.json({ success: true, id });
});

app.put("/make-server-04919ac5/projects/:id", async (c) => {
  const id = c.req.param("id");
  const updates = await c.req.json();
  const existing = await kvGet(id);
  if (!existing) return c.json({ success: false }, 404);
  await kvSet(id, { ...existing, ...updates, updatedAt: new Date().toISOString() });
  return c.json({ success: true });
});

app.delete("/make-server-04919ac5/projects/:id", async (c) => {
  await kvDelete(c.req.param("id"));
  return c.json({ success: true });
});

// CLIENTS
app.get("/make-server-04919ac5/clients", async (c) => {
  const clients = await kvGetByPrefix("client_");
  return c.json({ success: true, clients });
});

app.post("/make-server-04919ac5/clients", async (c) => {
  const client = await c.req.json();
  const id = client.id || `client_${Date.now()}`;
  await kvSet(id, { ...client, id, updatedAt: new Date().toISOString() });
  return c.json({ success: true, id });
});

// START
console.log("âœ… Minimal Server Ready!");
Deno.serve(app.fetch);

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FIN DU CODE - ARRÃŠTEZ DE COPIER ICI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

APRÃˆS DÃ‰PLOIEMENT :

1. Attendez 30 secondes que le serveur dÃ©marre

2. Testez dans la console :

fetch('https://ptcxeqtjlxittxayffgu.supabase.co/functions/v1/make-server-04919ac5/health')
  .then(r => r.json())
  .then(console.log)

3. Vous DEVEZ voir :
{
  "success": true,
  "message": "ðŸŽ‰ MINIMAL SERVER IS RUNNING!",
  "version": "minimal-1.0.0"
}

4. Si Ã§a marche, regardez les logs Supabase :
   https://supabase.com/dashboard/project/ptcxeqtjlxittxayffgu/logs/edge-functions

   Vous devriez voir :
   "ðŸš€ Minimal Server Starting..."
   "âœ… Minimal Server Ready!"

SI Ã‡A NE MARCHE PAS :
- VÃ©rifiez les logs pour voir l'erreur de compilation
- Copiez-moi l'erreur exacte
- On passera au dÃ©ploiement via CLI
